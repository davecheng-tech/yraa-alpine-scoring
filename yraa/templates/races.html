{% extends "base.html" %}

{% block title %}Race Results â€” YRAA{% endblock %}

{% block content %}
{% set diff_allowed = selected_race != "all" and not selected_school and not selected_athlete %}
<h2>Race Results</h2>

<details class="filters-panel"{% if filters_open %} open{% endif %}>
    <summary>
        Filters
        <span class="filter-chips">
            <span class="chip">{{ selected_group|title }}</span>
            <span class="chip">{{ selected_sport|title }}</span>
            <span class="chip">{{ 'HS' if selected_division == 'hs' else selected_division|title }}</span>
            {%- if races %}
                {%- if selected_race == "all" %}
            <span class="chip">All Races</span>
                {%- elif selected_race %}
            <span class="chip">Race {{ selected_race }}{% if event_date %} ({{ event_date }}){% endif %}</span>
                {%- endif %}
            {%- else %}
            <span class="chip">No Races</span>
            {%- endif %}
            {%- if selected_school %}
            <span class="chip">{{ selected_school }}</span>
            {%- endif %}
            {%- if selected_athlete %}
            <span class="chip">{{ selected_athlete|caps_last_name }}</span>
            {%- endif %}
        </span>
    </summary>

    <div class="grid grid-row1">
        <label>
            Group
            <select id="filter-group">
                {% for g in groups %}
                <option value="{{ g }}"{% if g == selected_group %} selected{% endif %}>{{ g|title }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Sport
            <select id="filter-sport">
                {% for s in sports %}
                <option value="{{ s }}"{% if s == selected_sport %} selected{% endif %}>{{ s|title }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Division
            <select id="filter-division">
                {% for d in divisions %}
                <option value="{{ d }}"{% if d == selected_division %} selected{% endif %}>{{ 'HS' if d == 'hs' else d|title }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Race
            <select id="filter-race">
                {% if has_narrowing_filter %}
                <option value="all"{% if selected_race == "all" %} selected{% endif %}>All Races</option>
                {% endif %}
                {% for r in races %}
                <option value="{{ r.seq }}"{% if r.seq == selected_race %} selected{% endif %}>Race {{ r.seq }} ({{ r.event_date }})</option>
                {% endfor %}
            </select>
        </label>
    </div>

    <div class="grid grid-row2">
        <label>
            School
            <select id="filter-school">
                <option value="">All Schools</option>
                {% for s in schools %}
                <option value="{{ s }}"{% if s == selected_school %} selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Athlete
            <select id="filter-athlete">
                <option value="">All Athletes</option>
                {% for a in athletes_list %}
                <option value="{{ a.value }}"{% if a.value == selected_athlete %} selected{% endif %}>{{ a.label }}</option>
                {% endfor %}
            </select>
        </label>
        <label id="time-display-label"{% if not diff_allowed %} class="disabled-filter"{% endif %}>
            Time Display
            <select id="filter-time-display"{% if not diff_allowed %} disabled{% endif %}>
                <option value="differential"{% if diff_allowed %} selected{% endif %}>Differential (+0.00)</option>
                <option value="absolute"{% if not diff_allowed %} selected{% endif %}>Actual Time</option>
            </select>
        </label>
    </div>
</details>

{% if results %}
<table>
    <thead>
        <tr>
            {% if selected_race == "all" %}<th class="rank">Race</th>{% endif %}
            <th class="rank">Place</th>
            <th>Athlete</th>
            <th>School</th>
            <th class="points">Time</th>
            <th class="points">Pts</th>
        </tr>
    </thead>
    <tbody>
        {% for r in results %}
        <tr data-athlete="{{ r.first_name }} {{ r.last_name }}">
            {% if selected_race == "all" %}<td class="rank">{{ r.race_seq }}</td>{% endif %}
            <td class="rank">{{ r.place }}</td>
            <td>{{ r.first_name }} {{ r.last_name|upper }}</td>
            <td>{{ r.school }}</td>
            <td class="points time-cell" data-time="{{ r.time_seconds if r.time_seconds else '' }}">{{ '%.2f' % r.time_seconds if r.time_seconds else '' }}</td>
            <td class="points">{{ r.points }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>No results found for this selection.</p>
{% endif %}

<script>
    function buildUrl(overrides) {
        var params = {
            group: document.getElementById('filter-group').value,
            sport: document.getElementById('filter-sport').value,
            division: document.getElementById('filter-division').value,
            race: document.getElementById('filter-race').value,
            school: document.getElementById('filter-school').value,
            athlete: document.getElementById('filter-athlete').value,
            filters: 'open'
        };
        Object.assign(params, overrides || {});
        var parts = [];
        for (var key in params) {
            if (params[key]) parts.push(key + '=' + encodeURIComponent(params[key]));
        }
        return '/races?' + parts.join('&');
    }
    function updateFilters() {
        window.location.href = buildUrl();
    }
    function onCategoryChange() {
        // Reset school/athlete when category changes
        window.location.href = buildUrl({school: '', athlete: ''});
    }
    function onSchoolChange() {
        // Reset athlete when school changes (athlete list depends on school)
        window.location.href = buildUrl({athlete: ''});
    }
    document.getElementById('filter-group').addEventListener('change', onCategoryChange);
    document.getElementById('filter-sport').addEventListener('change', onCategoryChange);
    document.getElementById('filter-division').addEventListener('change', onCategoryChange);
    document.getElementById('filter-race').addEventListener('change', updateFilters);
    document.getElementById('filter-school').addEventListener('change', onSchoolChange);
    document.getElementById('filter-athlete').addEventListener('change', function() {
        var athleteVal = document.getElementById('filter-athlete').value;
        // Default to "All Races" when selecting a specific athlete
        if (athleteVal) {
            window.location.href = buildUrl({race: 'all'});
        } else {
            window.location.href = buildUrl();
        }
    });

    // --- Time display toggle (differential vs absolute) ---
    var timeDisplaySelect = document.getElementById('filter-time-display');

    function applyTimeDisplay(mode) {
        var cells = document.querySelectorAll('.time-cell');
        if (!cells.length) return;

        // Find the leader time (first row with a valid time)
        var leaderTime = null;
        for (var i = 0; i < cells.length; i++) {
            var t = parseFloat(cells[i].dataset.time);
            if (!isNaN(t)) { leaderTime = t; break; }
        }

        cells.forEach(function(td) {
            var raw = parseFloat(td.dataset.time);
            if (isNaN(raw)) { td.textContent = ''; return; }

            if (mode === 'differential' && leaderTime !== null) {
                var diff = raw - leaderTime;
                if (diff === 0) {
                    td.textContent = raw.toFixed(2);
                } else {
                    td.textContent = '+' + diff.toFixed(2);
                }
            } else {
                td.textContent = raw.toFixed(2);
            }
        });

    }

    if (timeDisplaySelect) {
        timeDisplaySelect.addEventListener('change', function() {
            applyTimeDisplay(this.value);
        });
        // Apply initial mode on page load
        applyTimeDisplay(timeDisplaySelect.value);
    }

    // Highlight athlete row if linked from a dialog
    var params = new URLSearchParams(window.location.search);
    var highlight = params.get('highlight');
    if (highlight) {
        var athlete = highlight.trim();
        var rows = document.querySelectorAll('tr[data-athlete]');
        rows.forEach(function(row) {
            if (row.dataset.athlete.trim() === athlete) {
                var cells = row.querySelectorAll('td');
                cells.forEach(function(td) {
                    td.style.backgroundColor = 'rgba(255, 220, 100, 0.6)';
                    td.style.transition = 'background-color 2s ease-out';
                });
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(function() {
                    cells.forEach(function(td) {
                        td.style.backgroundColor = '';
                    });
                }, 1000);
            }
        });
    }
</script>
{% endblock %}
